<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Basketball Tracker</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .tab { display: flex; gap: 10px; cursor: pointer; margin-bottom: 20px; }
    .tab button { padding: 10px 20px; font-size: 16px; cursor: pointer; }
    .tab button.active { background-color: #007bff; color: white; }
    .content { display: none; }
    .content.active { display: block; }
    .button-grid { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; }
    .button-grid button { padding: 10px 20px; font-size: 16px; }
    #details, #players, #timeInput { display: none; margin-top: 20px; }
    .cancel-btn { margin-top: 20px; background-color: #f44336; color: white; border: none; padding: 10px 20px; cursor: pointer; font-size: 16px; display: block;}
    .cancel-btn:hover { background-color: #d32f2f; }
    .team-section { margin: 20px 0; }
    .team-section h3 { margin-bottom: 10px; }
    .player-row { display: flex; gap: 10px; margin-bottom: 5px; }
    .player-row input { width: 45%; padding: 5px; }
  </style>
</head>
<body>
  <h1>Basketball Tracker</h1>

  <!-- Tabs -->
  <div class="tab">
    <button onclick="showTab('tracking')" id="tab-tracking" class="active">Tracking</button>
    <button onclick="showTab('game-setup')" id="tab-game-setup">Game Setup</button>
  </div>

  <!-- Tracking Tab -->
  <div id="tracking" class="content active">
    <h2>Stat Tracking</h2>

    <!-- Action Buttons -->
    <div class="button-grid" id="actions">
      <button onclick="selectAction('shot make')">Shot Make</button>
      <button onclick="selectAction('shot miss')">Shot Miss</button>
      <button onclick="selectAction('rebound')">Rebound</button>
      <button onclick="selectAction('block')">Block</button>
      <button onclick="selectAction('steal')">Steal</button>
      <button onclick="selectAction('turnover')">Turnover</button>
      <button onclick="selectAction('foul')">Foul</button>
      <button onclick="selectAction('sub in')">Sub In</button>
      <button onclick="selectAction('sub out')">Sub Out</button>
      <button onclick="selectAction('record game time')">Record Game Time</button>
    </div>

    <!-- Detail Selection -->
    <div id="details">
      <h3 id="detailPrompt">Select Detail</h3>
      <div class="button-grid" id="detailOptions"></div>
      <button class="cancel-btn" onclick="resetUI()">Start Over</button>
    </div>

    <!-- Player Selection -->
    <div id="players">
    </div>

    <!-- Time Input -->
    <div id="timeInput">
      <h3>Enter Game Time</h3>
      <input type="text" id="gameTime" placeholder="MM:SS">
      <button onclick="recordGameTime()">Submit Time</button>
      <button class="cancel-btn" onclick="resetUI()">Start Over</button>
    </div>

    <button style="margin-top: 20px;" onclick="printActionDatabase()">Print Action Database</button>
    <button style="margin-top: 20px;" onclick="clearActionDatabase()">Clear Action Database</button>
    <button style="margin-top: 20px;" onclick="exportToCSV()">Export Actions to CSV</button>
    <button style="margin-top: 20px;" onclick="exportBoxScore()">Export Box Score to CSV</button>
  </div>

  <!-- Game Setup Tab -->
  <div id="game-setup" class="content">
    <h2>Game Setup</h2>

    <br>
    <button onclick="saveGame()">Save</button>
    <button onclick="loadGame()">Load</button>
    <button onclick="clearFields()">Clear</button>
    <button style="margin-top: 20px;" onclick="printGameDatabase()">Print Game Database</button>
    <button style="margin-top: 20px;" onclick="clearGameDatabase()">Clear Game Database</button>
    <br>

    <label for="game-id">Game ID:</label>
    <input type="text" id="game-id" placeholder="Enter Game ID"><br>
    <label for="game-date">Date:</label>
    <input type="date" id="game-date"><br>
    <label for="game-location">Location:</label>
    <input type="text" id="game-location" placeholder="Enter Location"><br>

    <div class="team-section">
      <h3>Team 1</h3>
      <input type="text" id="team1-name" placeholder="Enter Team 1 Name">
      <div id="team1-players"></div>
      <button onclick="addPlayerRow('team1')">Add Player</button>
    </div>

    <div class="team-section">
      <h3>Team 2</h3>
      <input type="text" id="team2-name" placeholder="Enter Team 2 Name">
      <div id="team2-players"></div>
      <button onclick="addPlayerRow('team2')">Add Player</button>
    </div>
  </div>

  <script>
    let currentAction = null;
    let detail1 = null; // Primary detail (e.g., points, offense/defense, etc.)
    let detail2 = null; // Secondary detail (e.g., type of shot, turnover type, etc.)
    let db;

    // Initialize IndexedDB
    const request = indexedDB.open("BasketballTrackerDB", 5);
    request.onupgradeneeded = (event) => {
      db = event.target.result;
      if (!db.objectStoreNames.contains("actions")) {
        db.createObjectStore("actions", { autoIncrement: true });
      }
      if (!db.objectStoreNames.contains("games")) {
        db.createObjectStore("games", { keyPath: "game_id" });
      }
    };
    request.onsuccess = (event) => { db = event.target.result; };

    // Tab Switching
    function showTab(tabId) {
      document.querySelectorAll('.content').forEach((el) => el.classList.remove('active'));
      document.querySelector(`#${tabId}`).classList.add('active');
      document.querySelectorAll('.tab button').forEach((el) => el.classList.remove('active'));
      document.querySelector(`#tab-${tabId}`).classList.add('active');
    }

    // Stat Tracking Functions (Existing Implementation)
    function resetUI() {
      currentAction = null;
      detail1 = null;
      detail2 = null;
      document.getElementById("actions").style.display = "flex";
      document.getElementById("details").style.display = "none";
      document.getElementById("players").style.display = "none";
      document.getElementById("timeInput").style.display = "none";
    }

    function selectAction(action) {
      currentAction = action;
      detail1 = null;
      detail2 = null;
      document.getElementById("actions").style.display = "none";
    
      if (action.startsWith("shot")) {
        showDetailOptions("Points", ["Free Throw", "2-Pointer", "3-Pointer"]);
      } else if (action === "rebound") {
        showDetailOptions("Rebound Type", ["Offensive", "Defensive"]);
      } else if (action === "turnover") {
        showDetailOptions("Turnover Type", ["Ball Stolen", "Traveling", "Out of Bounds", "Double Dribble", "Other"]);
      } else if (action === "foul") {
        showDetailOptions("Foul Type", ["Offensive", "Defensive"]);
      } else if (action === "record game time") {
        document.getElementById("timeInput").style.display = "block";
      } else {
        showPlayerButtons(); // Show player buttons based on loaded teams
      }
    }

    function showPlayerButtons() {
      const playersContainer = document.getElementById("players");
      playersContainer.innerHTML = "";

      const transaction = db.transaction("games", "readonly");
      const store = transaction.objectStore("games");
      const gameId = document.getElementById("game-id").value;

      if (!gameId) {
        alert("Please enter and load a valid Game ID before tracking.");
        resetUI();
        return;
      }

      const request = store.get(gameId);
      request.onsuccess = (event) => {
        const gameData = event.target.result;
        if (!gameData) {
          alert("No game data found for the given Game ID.");
          resetUI();
          return;
        }

        // Team 1 section
        const team1Header = document.createElement("h4");
        team1Header.textContent = gameData.team1.name || "Team 1";
        playersContainer.appendChild(team1Header);

        // Team 1 "Team" button
        const team1Button = document.createElement("button");
        team1Button.textContent = "Team";
        team1Button.onclick = () => recordAction(gameData.team1.name, null);
        playersContainer.appendChild(team1Button);

        // Team 1 player buttons
        gameData.team1.players.forEach(player => {
          if ((currentAction === "sub in" && player.status !== "in") || 
              (currentAction !== "sub in" && player.status === "in")) {
            const button = document.createElement("button");
            button.textContent = `${player.number || ""} ${player.name || ""}`.trim();
            button.onclick = () => recordAction(gameData.team1.name, player.number);
            playersContainer.appendChild(button);
          }
        });

        // Team 2 section
        const team2Header = document.createElement("h4");
        team2Header.textContent = gameData.team2.name || "Team 2";
        playersContainer.appendChild(team2Header);

        // Team 2 "Team" button
        const team2Button = document.createElement("button");
        team2Button.textContent = "Team";
        team2Button.onclick = () => recordAction(gameData.team2.name, null);
        playersContainer.appendChild(team2Button);

        // Team 2 player buttons
        gameData.team2.players.forEach(player => {
          if ((currentAction === "sub in" && player.status !== "in") || 
              (currentAction !== "sub in" && player.status === "in")) {
            const button = document.createElement("button");
            button.textContent = `${player.number || ""} ${player.name || ""}`.trim();
            button.onclick = () => recordAction(gameData.team2.name, player.number);
            playersContainer.appendChild(button);
          }
        });

        // Add "Start Over" button
        const startOverButton = document.createElement("button");
        startOverButton.textContent = "Start Over";
        startOverButton.classList.add("cancel-btn");
        startOverButton.onclick = resetUI;
        playersContainer.appendChild(startOverButton);

        playersContainer.style.display = "block";
      };
    }



    function showDetailOptions(prompt, options) {
      document.getElementById("details").style.display = "block";
      document.getElementById("detailPrompt").innerText = `Select ${prompt}`;
      const detailOptions = document.getElementById("detailOptions");
      detailOptions.innerHTML = "";
      options.forEach(option => {
        const button = document.createElement("button");
        button.textContent = option;
        button.onclick = () => handleDetailSelection(option);
        detailOptions.appendChild(button);
      });
    }

    function handleDetailSelection(option) {
      if (!detail1) {
        detail1 = option;
        if (currentAction.startsWith("shot") && detail1 === "2-Pointer") {
          showDetailOptions("Shot Type", [
            "Lay Up", "Paint - Near", "Paint - Far",
            "Mid-Range - Left Baseline", "Mid-Range - Right Baseline",
            "Mid-Range - Left Wing", "Mid-Range - Right Wing",
            "Mid-Range - Top of the Key"
          ]);
        } else if (currentAction.startsWith("shot") && detail1 === "3-Pointer") {
          showDetailOptions("Shot Type", [
            "Three-Point - Left Corner", "Three-Point - Right Corner",
            "Three-Point - Left Wing", "Three-Point - Right Wing",
            "Three-Point - Top of the Arc"
          ]);
        } else {
          document.getElementById("details").style.display = "none";
          showPlayerButtons(); // Show player buttons after first-level detail
        }
      } else {
        detail2 = option;
        document.getElementById("details").style.display = "none";
        showPlayerButtons(); // Show player buttons after second-level detail
      }
    }
    function recordAction(teamName, jerseyNumber) {
      const gameId = document.getElementById("game-id").value;
      const data = {
        game_id: gameId,
        action: currentAction,
        team: teamName,
        playerNumber: jerseyNumber,
        detail1: detail1,
        detail2: detail2,
        timestamp: new Date().toISOString()
      };
      console.log("Recorded:", data);
    
      const transaction = db.transaction("actions", "readwrite");
      const store = transaction.objectStore("actions");
      store.add(data);
    
      // Update player status for substitutions
      const action = currentAction;
      if (currentAction === "sub in" || currentAction === "sub out") {
        const gameTransaction = db.transaction("games", "readwrite");
        const gameStore = gameTransaction.objectStore("games");
    
        const gameRequest = gameStore.get(gameId);
        gameRequest.onsuccess = (event) => {
          const gameData = event.target.result;
          if (!gameData) return;
    
          const teamKey = gameData.team1.name === teamName ? "team1" : "team2";
          const players = gameData[teamKey].players.map(player => {
            if (player.number === jerseyNumber) {
              return { ...player, status: action === "sub in" ? "in" : "out" };
            }
            return player;
          });
    
          gameData[teamKey].players = players;
          gameStore.put(gameData);
        };
      }
    
      resetUI();
    }


    function recordGameTime() {
      const time = document.getElementById("gameTime").value;
      if (!time) {
        alert("Please enter a valid time!");
        return;
      }
      const data = { action: "record game time", time: time, timestamp: new Date().toISOString() };
      console.log("Recorded:", data);

      const transaction = db.transaction("actions", "readwrite");
      const store = transaction.objectStore("actions");
      store.add(data);

      resetUI(); // Reset UI to main actions
    }

    function printActionDatabase() {
      const transaction = db.transaction("actions", "readonly");
      const store = transaction.objectStore("actions");
      const request = store.getAll();

      request.onsuccess = (event) => {
        console.log("Full Database:", event.target.result);
      };
    }

    function printGameDatabase() {
      const transaction = db.transaction("games", "readonly");
      const store = transaction.objectStore("games");
      const request = store.getAll();
    
      request.onsuccess = (event) => {
        console.log("Full Game Database:", event.target.result);
      };
    }
    
    function clearActionDatabase() {
      const transaction = db.transaction("actions", "readwrite");
      const store = transaction.objectStore("actions");
      const request = store.clear();
    
      request.onsuccess = () => {
        console.log("Action Database cleared.");
      };
    }
    
    function clearGameDatabase() {
      const transaction = db.transaction("games", "readwrite");
      const store = transaction.objectStore("games");
      const request = store.clear();
    
      request.onsuccess = () => {
        console.log("Game Database cleared.");
      };
    }


    function exportToCSV() {
      const gameId = document.getElementById("game-id").value;
      if (!gameId) {
        alert("Please enter a Game ID to export");
        return;
      }

      const transaction = db.transaction("actions", "readonly");
      const store = transaction.objectStore("actions");
      const request = store.getAll();

      request.onsuccess = (event) => {
        const allActions = event.target.result;
        const gameActions = allActions.filter(action => action.game_id === gameId);
        
        // Create CSV header
        const headers = ["game_id", "action", "team", "playerNumber", "detail1", "detail2", "timestamp"];
        let csvContent = headers.join(",") + "\n";
        
        // Add data rows
        gameActions.forEach(action => {
          const row = [
            action.game_id,
            action.action,
            action.team,
            action.playerNumber || "",
            action.detail1 || "",
            action.detail2 || "",
            action.timestamp
          ].map(value => `"${value}"`).join(",");
          csvContent += row + "\n";
        });

        // Create and trigger download
        const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", `game_${gameId}_actions.csv`);
        link.style.visibility = "hidden";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      };
    }
    function exportBoxScore() {
      const gameId = document.getElementById("game-id").value;
      if (!gameId) {
        alert("Please enter a Game ID to export");
        return;
      }

      const transaction = db.transaction(["actions", "games"], "readonly");
      const actionStore = transaction.objectStore("actions");
      const gameStore = transaction.objectStore("games");

      const actionRequest = actionStore.getAll();
      const gameRequest = gameStore.get(gameId);

      Promise.all([
        new Promise(resolve => {
          actionRequest.onsuccess = () => resolve(actionRequest.result);
        }),
        new Promise(resolve => {
          gameRequest.onsuccess = () => resolve(gameRequest.result);
        })
      ]).then(([actions, gameData]) => {
        const gameActions = actions.filter(action => action.game_id === gameId);
        
        // Initialize player stats with new categories
        const playerStats = {};
        [gameData.team1, gameData.team2].forEach(team => {
          team.players.forEach(player => {
            playerStats[`${team.name}-${player.number}`] = {
              team: team.name,
              number: player.number,
              name: player.name,
              ftMade: 0,
              ftMissed: 0,
              twoPtMade: 0,
              twoPtMissed: 0,
              threePtMade: 0,
              threePtMissed: 0,
              offRebounds: 0,
              defRebounds: 0,
              totalRebounds: 0,
              fouls: 0,
              steals: 0,
              blocks: 0,
              turnovers: 0,
              totalPoints: 0
            };
          });
        });

        // Calculate stats
        gameActions.forEach(action => {
          const key = `${action.team}-${action.playerNumber}`;
          if (!playerStats[key]) return;

          const stats = playerStats[key];
          
          switch(action.action) {
            case 'shot make':
              if (action.detail1 === 'Free Throw') {
                stats.ftMade++;
                stats.totalPoints++;
              } else if (action.detail1 === '2-Pointer') {
                stats.twoPtMade++;
                stats.totalPoints += 2;
              } else if (action.detail1 === '3-Pointer') {
                stats.threePtMade++;
                stats.totalPoints += 3;
              }
              break;
            case 'shot miss':
              if (action.detail1 === 'Free Throw') {
                stats.ftMissed++;
              } else if (action.detail1 === '2-Pointer') {
                stats.twoPtMissed++;
              } else if (action.detail1 === '3-Pointer') {
                stats.threePtMissed++;
              }
              break;
            case 'rebound':
              if (action.detail1 === 'Offensive') {
                stats.offRebounds++;
              } else if (action.detail1 === 'Defensive') {
                stats.defRebounds++;
              }
              stats.totalRebounds = stats.offRebounds + stats.defRebounds;
              break;
            case 'foul':
              stats.fouls++;
              break;
            case 'steal':
              stats.steals++;
              break;
            case 'block':
              stats.blocks++;
              break;
            case 'turnover':
              stats.turnovers++;
              break;
          }
        });

        // Create CSV content with new columns
        const headers = [
          "Team", "Number", "Name", 
          "FT Made", "FT Missed",
          "2PT Made", "2PT Missed",
          "3PT Made", "3PT Missed",
          "Off Rebounds", "Def Rebounds", "Total Rebounds",
          "Fouls", "Steals", "Blocks", "Turnovers",
          "Total Points"
        ];
        
        let csvContent = headers.join(",") + "\n";

        Object.values(playerStats).forEach(stats => {
          const row = [
            stats.team,
            stats.number,
            stats.name,
            stats.ftMade,
            stats.ftMissed,
            stats.twoPtMade,
            stats.twoPtMissed,
            stats.threePtMade,
            stats.threePtMissed,
            stats.offRebounds,
            stats.defRebounds,
            stats.totalRebounds,
            stats.fouls,
            stats.steals,
            stats.blocks,
            stats.turnovers,
            stats.totalPoints
          ].map(value => `"${value}"`).join(",");
          csvContent += row + "\n";
        });

        // Download CSV
        const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", `game_${gameId}_boxscore.csv`);
        link.style.visibility = "hidden";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      });
    }

    // Game Setup Functions
    function addPlayerRow(team) {
      const teamPlayers = document.querySelector(`#${team}-players`);
      const playerRow = document.createElement('div');
      playerRow.classList.add('player-row');
      playerRow.innerHTML = `<input type="text" placeholder="Number"><input type="text" placeholder="Name">`;
      teamPlayers.appendChild(playerRow);
    }

    function saveGame() {
      const gameId = document.getElementById('game-id').value;
      if (!gameId) {
        alert('Game ID is required to save.');
        return;
      }
      const gameData = {
        game_id: gameId,
        date: document.getElementById('game-date').value,
        location: document.getElementById('game-location').value,
        team1: {
          name: document.getElementById('team1-name').value,
          players: getPlayers('team1').map(player => ({ ...player, status: player.status || "out" }))
        },
        team2: {
          name: document.getElementById('team2-name').value,
          players: getPlayers('team2').map(player => ({ ...player, status: player.status || "out" }))
        },
      };
      const transaction = db.transaction('games', 'readwrite');
      transaction.objectStore('games').put(gameData);
      alert('Game saved successfully!');
    }

    function loadGame() {
      const gameId = document.getElementById('game-id').value;
      if (!gameId) {
        alert('Enter Game ID to load.');
        return;
      }
      const transaction = db.transaction('games', 'readonly');
      const request = transaction.objectStore('games').get(gameId);
      request.onsuccess = (event) => {
        const gameData = event.target.result;
        if (!gameData) {
          alert('No game found.');
          return;
        }
        document.getElementById('game-date').value = gameData.date;
        document.getElementById('game-location').value = gameData.location;
        document.getElementById('team1-name').value = gameData.team1.name;
        document.getElementById('team2-name').value = gameData.team2.name;
        setPlayers('team1', gameData.team1.players);
        setPlayers('team2', gameData.team2.players);
      };
    }


    function clearFields() {
      document.getElementById('game-id').value = '';
      document.getElementById('game-date').value = '';
      document.getElementById('game-location').value = '';
      document.getElementById('team1-name').value = '';
      document.getElementById('team2-name').value = '';
      document.getElementById('team1-players').innerHTML = '';
      document.getElementById('team2-players').innerHTML = '';
    }

    function getPlayers(team) {
      const rows = document.querySelectorAll(`#${team}-players .player-row`);
      return Array.from(rows).map(row => {
        const inputs = row.querySelectorAll('input');
        return { number: inputs[0].value, name: inputs[1].value };
      }).filter(p => p.number || p.name);
    }

    function setPlayers(team, players) {
      const container = document.getElementById(`${team}-players`);
      container.innerHTML = '';
      players.forEach(player => {
        const playerRow = document.createElement('div');
        playerRow.classList.add('player-row');
        playerRow.innerHTML = `<input type="text" value="${player.number}" placeholder="Number"><input type="text" value="${player.name}" placeholder="Name">`;
        container.appendChild(playerRow);
      });
    }
  </script>
</body>
</html>
